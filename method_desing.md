---

<!-- 文件名建议：02_Dynamic-Graph-Mixer.md -->

# 方法二：Dynamic Graph Mixer Forecaster（显式建模“时变耦合结构”的动态图预测主干）

> **定位声明（与大论文框架接口）**  
> - 不重复你的非平稳预处理：输入直接使用 `X_norm` 与统计量 `S`。  
> - 不把在线学习当作本方法主体：本方法通过 **模型内部的动态图生成器** 在前向计算中实现“结构随时间变化”。  
> - 该 backbone 特别适合工业场景中“阀位策略切换、回路投切、配方切换、负荷变化”导致的 **跨变量耦合结构变化**。

---

## 1. 立意（Intent）

工业多变量预测的核心难点常常是：

> **跨变量耦合不是固定的**：耦合强度、方向、滞后结构会随工况变化。

如果 backbone 采用“静态跨变量混合”（固定全连接注意力/固定线性 mixing），当工况切换时模型会出现系统性偏差。

因此，本方法明确提出：  
**将跨变量关系建模为随时间/阶段变化的动态图（dynamic coupling graph）**，并用该图驱动信息传播与混合。

---

## 2. 动机（Motivation）

### 2.1 为什么动态图比“直接跨变量注意力”更适合工业？
- 跨变量注意力在短尺度上容易学到噪声诱导的伪相关  
- 图结构可施加更强先验：稀疏性、平滑性、物理拓扑偏置  
- 图可以提供可解释性：哪几个变量在当前工况对目标更重要

### 2.2 关键设计哲学
- **时间特征先在变量内抽取**（避免一开始就跨变量全连接）  
- **耦合图在更粗的时间尺度生成**（抗短期伪相关）  
- **传播算子可低秩/稀疏**（工业变量维度大）

---

## 3. 问题定义与接口

- 输入：`X_norm ∈ R^{L×C}`（来自你的预处理）  
- 可选统计量：`S`（μ/σ 或你自己的非平稳参数）  
- 可选外生：`U ∈ R^{(L+H)×D_u}`  
- 输出：`Y_hat ∈ R^{H×C}`

---

## 4. 总体结构（Overview）

### 4.1 分两段建模
1) **变量内时间编码（Temporal Encoder）**  
   对每个变量独立提取时间动态表征：  
   `H_time ∈ R^{C×N×d}`（N 为 token 数）
2) **动态图生成 + 图混合（Dynamic Graph + Mixing）**  
   在每个（粗尺度）时间片生成耦合矩阵 `A_t ∈ R^{C×C}`，再进行跨变量信息传播：  
   `H_mix[t] = A_t · H_time[t]`

最终通过解码头输出预测。

---

## 5. 模块拆解与组件可选方案

---

### 模块 A：Temporal Encoder（变量内时间特征抽取）

目标：先把每个变量的“可预测结构”抽出来，再做跨变量传播。

**A1. TCN / Dilated Conv（工业友好，速度快）**
- 适合：实时性要求高、噪声较大

**A2. Transformer（表达力强）**
- 适合：长依赖显著、周期复杂

**A3. SSM（状态空间块）**
- 适合：超长序列或需要更稳定的长程建模

> 输入可用 patch tokens（更长尺度），也可直接用点级序列。

---

### 模块 B：Dynamic Graph Generator（核心：生成时变耦合矩阵 A_t）

你可以把 `A_t` 看作“当前阶段的跨变量 mixing 权重”。

#### 方案 B1：低秩动态图（推荐）
用低秩因子生成：
- `U_t = f_u(z_t)`，`V_t = f_v(z_t)`，其中 `U_t, V_t ∈ R^{C×r}`，`r << C`
- `A_t = RowSoftmax(U_t V_t^T + B_prior)`

其中 `z_t` 是图生成器的输入特征，可选：
- `Pool(H_time at time t)`（最常用）
- `Embed(S)`（统计量作为工况指纹）
- `Pool(U)`（控制量/设定点强相关）

优点：O(Cr) 可扩展到上百/上千变量。

#### 方案 B2：Top-k 稀疏图（更可解释）
- 对每个节点只保留 top-k 邻居：  
  `A_t[i, :] = TopKSoftmax(score_i, k)`
- 工业优点：与工艺流程稀疏连接更一致；解释更直观

#### 方案 B3：图字典 + 门控混合（工况离散时很强）
- 预先学习 K 个“原型图” `{A^1,...,A^K}`  
- 当前时刻用门控 `π_t = softmax(g(z_t))` 混合：  
  `A_t = Σ_k π_{t,k} A^k`
- 适合：配方/工况切换明显的过程

#### 方案 B4：物理先验图 + 残差修正（稳健）
- `A_t = A_prior + ΔA_t`
- `ΔA_t` 用低秩/稀疏参数化，避免模型学到不合理连接

---

### 模块 C：Graph Mixing（图传播/混合算子）

给定某个时间片的变量特征矩阵：`M_t ∈ R^{C×d}`

**C1. 线性 mixing（最快）**
- `M'_t = A_t M_t`
- 再加残差：`M_t ← M_t + M'_t`

**C2. Graph Attention（表达更强）**
- score 基于节点对特征相似度 + 图先验  
- 注意要控制复杂度与过拟合（工业噪声大）

**C3. Diffusion / 有向传播（适合因果/流向明确的工艺）**
- 允许有向邻接，传播更符合“上游影响下游”

---

### 模块 D：Anti-spurious 设计（抗伪相关的关键策略）

> 这是动态图路线能否稳定超过 baseline 的关键。

**D1. 粗尺度生成图（强烈推荐）**
- 先对时间维下采样：每 `P_long` 个点/patch 生成一次 `A_t`  
- 再 broadcast 到细尺度使用  
- 直觉：短期噪声对图结构的干扰更小

**D2. 图时间平滑正则（结构层面抑制抖动）**
- 在训练中加入结构平滑（不属于损失创新，属于结构稳定项，可写为 regularizer）：  
  `||A_t - A_{t-1}||_1` 或 `||U_t-U_{t-1}||_2`

**D3. 生成图只看“稳定特征”**
- 图生成器输入 `z_t` 优先使用：  
  - `X_norm` 的低频/池化特征  
  - 或差分/增量特征（减少绝对水平引发的伪相关）

---

### 模块 E：输出解码头（Forecast Head）

**E1. 直接线性多步头**
- `Y_hat = Linear(Flatten(H_last))`

**E2. Seq2Seq 解码**
- 若你更关注多步滚动一致性，可用轻量 decoder

---

## 6. 推理流程（Pseudo）

1) 输入 `(X_norm, S, U)`  
2) 时间编码：`H_time = TemporalEncoder(X_norm)`  
3) 下采样得到 `H_long`（可选但推荐）  
4) 对每个 long 时间片生成 `A_t`  
5) 图混合：`H_mix[t] = A_t · H_time[t]`（或对应广播）  
6) 解码输出 `Y_hat`

---

## 7. 推荐消融（论文可写）

- 静态图（学习一个 A） vs 动态图（A_t）  
- 动态图：低秩 vs top-k vs 图字典  
- 图生成尺度：细尺度生成 vs 粗尺度生成（检验抗伪相关）  
- 是否使用 `S` / `U` 作为图生成条件

---

## 8. 风险与注意事项（工业实用）

- 动态图过强会导致不稳定：优先从 B1（低秩）+ D1（粗尺度）起步  
- 工况极其复杂时，图字典（B3）更稳  
- 若变量数很大：必须低秩/分组（否则 O(C^2) 不可用）

---
